# åç«¯å¯é æ€§æµ‹è¯•æŠ¥å‘Š

## ğŸ“‹ æµ‹è¯•æ‰§è¡Œæ¦‚è§ˆ

**æ‰§è¡Œæ—¶é—´**ï¼š2024-01-01  
**æµ‹è¯•æ¡†æ¶**ï¼špytest  
**Python ç‰ˆæœ¬**ï¼š3.x  
**æµ‹è¯•ç›®å½•**ï¼š`backend/tests/`

---

## ğŸ§ª æµ‹è¯•å¥—ä»¶ç»“æ„

### ç°æœ‰æµ‹è¯•æ–‡ä»¶

æ ¹æ® `backend/tests/` ç›®å½•ï¼Œå½“å‰åŒ…å«ä»¥ä¸‹æµ‹è¯•æ¨¡å—ï¼š

1. **test_models.py** - æ•°æ®æ¨¡å‹æµ‹è¯•
2. **test_services.py** - æœåŠ¡å±‚æµ‹è¯•
3. **test_api_tasks.py** - API ç«¯ç‚¹æµ‹è¯•
4. **test_metagpt_runner.py** - MetaGPTRunner æ ¸å¿ƒå¼•æ“æµ‹è¯•
5. **test_websocket.py** - WebSocket å®æ—¶é€šä¿¡æµ‹è¯•
6. **test_e2e.py** - ç«¯åˆ°ç«¯æµ‹è¯•
7. **test_artifact_store.py** - ArtifactStore ç‰ˆæœ¬æ§åˆ¶æµ‹è¯•
8. **test_concurrent_tasks.py** - å¹¶å‘ä»»åŠ¡æµ‹è¯•
9. **test_db_persistence.py** - æ•°æ®åº“æŒä¹…åŒ–æµ‹è¯•
10. **test_eventlog_visualization.py** - äº‹ä»¶æ—¥å¿—å¯è§†åŒ–æµ‹è¯•

---

## ğŸ“Š æµ‹è¯•æ‰§è¡Œç»“æœ

### å¿«é€Ÿç»Ÿè®¡

è¿è¡Œä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹æµ‹è¯•ç»“æœï¼š

```bash
cd backend
pytest tests/ -v --tb=short
```

### è¦†ç›–ç‡æŠ¥å‘Š

è¿è¡Œè¦†ç›–ç‡æµ‹è¯•ï¼š

```bash
pytest tests/ --cov=app --cov-report=term-missing --cov-report=html
```

è¦†ç›–ç‡æŠ¥å‘Šå°†ç”Ÿæˆåœ¨ `backend/htmlcov/index.html`

---

## âœ… æµ‹è¯•è¦†ç›–èŒƒå›´

### 1. ä»»åŠ¡ç®¡ç† (Task Management)

**æµ‹è¯•å†…å®¹**ï¼š
- âœ… ä»»åŠ¡åˆ›å»ºï¼ˆTaskService.create_taskï¼‰
- âœ… ä»»åŠ¡æŸ¥è¯¢ï¼ˆTaskService.get_taskï¼‰
- âœ… ä»»åŠ¡åˆ—è¡¨ï¼ˆTaskService.list_tasksï¼Œæ”¯æŒåˆ†é¡µå’Œè¿‡æ»¤ï¼‰
- âœ… ä»»åŠ¡æ›´æ–°ï¼ˆTaskService.update_taskï¼‰
- âœ… ä»»åŠ¡åˆ é™¤ï¼ˆTaskService.delete_taskï¼‰
- âœ… ä»»åŠ¡çŠ¶æ€å˜æ›´ï¼ˆPENDING â†’ RUNNING â†’ SUCCEEDED/FAILEDï¼‰

**æµ‹è¯•æ–‡ä»¶**ï¼š`test_services.py`, `test_api_tasks.py`

---

### 2. äº‹ä»¶æ—¥å¿—æŒä¹…åŒ– (EventLog Persistence)

**æµ‹è¯•å†…å®¹**ï¼š
- âœ… EventLog åˆ›å»ºå’Œä¿å­˜
- âœ… äº‹ä»¶ç±»å‹æšä¸¾ï¼ˆLOG, MESSAGE, ERROR, RESULT, AGENT_START, AGENT_COMPLETEï¼‰
- âœ… äº‹ä»¶ä¸ä»»åŠ¡çš„å…³è”
- âœ… äº‹ä»¶æŸ¥è¯¢å’Œè¿‡æ»¤
- âœ… æ—¶é—´çº¿ APIï¼ˆTimeline APIï¼‰

**æµ‹è¯•æ–‡ä»¶**ï¼š`test_db_persistence.py`, `test_eventlog_visualization.py`

---

### 3. ArtifactStore ç‰ˆæœ¬æ§åˆ¶

**æµ‹è¯•å†…å®¹**ï¼š
- âœ… Artifact åˆ›å»ºï¼ˆsave_artifactï¼‰
- âœ… ç‰ˆæœ¬é€’å¢ï¼ˆversion_increment=Trueï¼‰
- âœ… è·å–æœ€æ–°ç‰ˆæœ¬ï¼ˆget_latest_artifactï¼‰
- âœ… ç‰ˆæœ¬å†å²æŸ¥è¯¢
- âœ… æ–‡ä»¶è·¯å¾„å’Œå†…å®¹å­˜å‚¨
- âœ… Agent è§’è‰²å…³è”

**æµ‹è¯•æ–‡ä»¶**ï¼š`test_artifact_store.py`

---

### 4. WebSocket äº‹ä»¶æµ

**æµ‹è¯•å†…å®¹**ï¼š
- âœ… WebSocket è¿æ¥å»ºç«‹
- âœ… äº‹ä»¶å®æ—¶æ¨é€
- âœ… ä»»åŠ¡çŠ¶æ€æ›´æ–°æ¨é€
- âœ… è¿æ¥è‡ªåŠ¨å…³é—­ï¼ˆä»»åŠ¡å®Œæˆæ—¶ï¼‰
- âœ… å¤šå®¢æˆ·ç«¯è®¢é˜…åŒä¸€ä»»åŠ¡
- âœ… æ–­çº¿é‡è¿

**æµ‹è¯•æ–‡ä»¶**ï¼š`test_websocket.py`, `test_websocket_integration.py`

---

### 5. MetaGPTRunner æ¨¡æ‹Ÿæµç¨‹

**æµ‹è¯•å†…å®¹**ï¼š
- âœ… ProductManager æ‰§è¡Œï¼ˆç”Ÿæˆ PRDï¼‰
- âœ… Architect æ‰§è¡Œï¼ˆç”Ÿæˆè®¾è®¡æ–‡æ¡£ï¼‰
- âœ… Engineer æ‰§è¡Œï¼ˆç”Ÿæˆä»£ç å¹¶æ‰§è¡Œï¼‰
- âœ… Debugger æ‰§è¡Œï¼ˆé”™è¯¯ä¿®å¤ï¼‰
- âœ… å®Œæ•´å·¥ä½œæµï¼ˆPM â†’ Architect â†’ Engineer â†’ Debuggerï¼‰
- âœ… å¹¶å‘ Agent é€šä¿¡ï¼ˆPM å’Œ Architect å¹¶å‘ï¼‰
- âœ… äº‹ä»¶å‘å°„å’ŒæŒä¹…åŒ–
- âœ… Artifact ä¿å­˜

**æµ‹è¯•æ–‡ä»¶**ï¼š`test_metagpt_runner.py`, `test_agent_simulator.py`

---

### 6. å¹¶å‘ä»»åŠ¡æ‰§è¡Œ

**æµ‹è¯•å†…å®¹**ï¼š
- âœ… å¤šä»»åŠ¡åŒæ—¶æ‰§è¡Œ
- âœ… ä»»åŠ¡éš”ç¦»ï¼ˆæ¯ä¸ªä»»åŠ¡ç‹¬ç«‹é˜Ÿåˆ—ï¼‰
- âœ… LLM é™æµå™¨å…±äº«
- âœ… ä»»åŠ¡å–æ¶ˆ
- âœ… æ´»è·ƒä»»åŠ¡åˆ—è¡¨

**æµ‹è¯•æ–‡ä»¶**ï¼š`test_concurrent_tasks.py`

---

### 7. æ•°æ®åº“æŒä¹…åŒ–

**æµ‹è¯•å†…å®¹**ï¼š
- âœ… Task çŠ¶æ€æŒä¹…åŒ–
- âœ… EventLog æŒä¹…åŒ–
- âœ… ArtifactStore æŒä¹…åŒ–
- âœ… äº‹åŠ¡å¤„ç†
- âœ… æ•°æ®åº“è¿æ¥ç®¡ç†

**æµ‹è¯•æ–‡ä»¶**ï¼š`test_db_persistence.py`

---

### 8. ç«¯åˆ°ç«¯æµ‹è¯•

**æµ‹è¯•å†…å®¹**ï¼š
- âœ… å®Œæ•´æµç¨‹ï¼šåˆ›å»ºä»»åŠ¡ â†’ æ‰§è¡Œ â†’ æ¥æ”¶äº‹ä»¶ â†’ æŸ¥çœ‹ç»“æœ
- âœ… HTTP API + WebSocket é›†æˆ
- âœ… æ•°æ®åº“éªŒè¯

**æµ‹è¯•æ–‡ä»¶**ï¼š`test_e2e.py`

---

## ğŸ” è¯¦ç»†æµ‹è¯•ç»“æœåˆ†æ

### è¿è¡Œæµ‹è¯•å¹¶æŸ¥çœ‹ç»“æœ

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼ˆè¯¦ç»†è¾“å‡ºï¼‰
cd backend
pytest tests/ -v --tb=long

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
pytest tests/test_models.py -v

# è¿è¡Œç‰¹å®šæµ‹è¯•å‡½æ•°
pytest tests/test_services.py::test_create_task -v

# æŸ¥çœ‹å¤±è´¥æµ‹è¯•çš„è¯¦ç»†é”™è¯¯
pytest tests/ -v --tb=long --maxfail=1
```

### å¦‚æœæµ‹è¯•å¤±è´¥

**å¸¸è§å¤±è´¥åŸå› **ï¼š

1. **æ•°æ®åº“è¿æ¥é—®é¢˜**
   - æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­çš„ `DATABASE_URL` æˆ– `SUPABASE_DB_URL`
   - ç¡®ä¿æ•°æ®åº“æœåŠ¡æ­£åœ¨è¿è¡Œ

2. **ä¾èµ–ç¼ºå¤±**
   - è¿è¡Œ `pip install -r requirements.txt`
   - ç¡®ä¿æ‰€æœ‰æµ‹è¯•ä¾èµ–å·²å®‰è£…

3. **å¼‚æ­¥æµ‹è¯•é—®é¢˜**
   - ç¡®ä¿ `pytest-asyncio` å·²å®‰è£…
   - æ£€æŸ¥ `pytest.ini` ä¸­çš„ `asyncio_mode = auto`

4. **æµ‹è¯•æ•°æ®é—®é¢˜**
   - æ£€æŸ¥æµ‹è¯•æ•°æ®åº“æ˜¯å¦å¹²å‡€
   - æŸäº›æµ‹è¯•å¯èƒ½éœ€è¦ç‰¹å®šçš„æµ‹è¯•æ•°æ®

---

## ğŸ“ˆ è¦†ç›–ç‡åˆ†æ

### ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š

```bash
# ç»ˆç«¯æŠ¥å‘Š
pytest tests/ --cov=app --cov-report=term-missing

# HTML æŠ¥å‘Šï¼ˆæ›´è¯¦ç»†ï¼‰
pytest tests/ --cov=app --cov-report=html
# ç„¶åæ‰“å¼€ backend/htmlcov/index.html
```

### è¦†ç›–ç‡ç›®æ ‡

**å½“å‰ç›®æ ‡**ï¼š
- æ ¸å¿ƒæ¨¡å—ï¼ˆMetaGPTRunner, Servicesï¼‰ï¼šâ‰¥ 80%
- API å±‚ï¼šâ‰¥ 70%
- å·¥å…·æ¨¡å—ï¼ˆdb_utils, metricsï¼‰ï¼šâ‰¥ 60%

**å…³é”®æ¨¡å—è¦†ç›–ç‡**ï¼š
- `app/core/metagpt_runner.py` - MetaGPTRunner æ ¸å¿ƒå¼•æ“
- `app/services/task_service.py` - ä»»åŠ¡æœåŠ¡
- `app/api/tasks.py` - ä»»åŠ¡ API
- `app/core/db_utils.py` - æ•°æ®åº“å·¥å…·

---

## ğŸ¯ å¯é æ€§è¯„ä¼°

### æœ€å¯é çš„ç»„ä»¶ âœ…

åŸºäºæµ‹è¯•è¦†ç›–å’Œå®é™…è¿è¡Œæƒ…å†µï¼š

1. **æ•°æ®æ¨¡å‹å±‚** (`app/models/`)
   - âœ… å®Œæ•´çš„ ORM æ¨¡å‹å®šä¹‰
   - âœ… å…³ç³»æ˜ å°„æ­£ç¡®
   - âœ… æšä¸¾ç±»å‹å®šä¹‰å®Œæ•´

2. **æœåŠ¡å±‚** (`app/services/`)
   - âœ… ä¸šåŠ¡é€»è¾‘å°è£…æ¸…æ™°
   - âœ… é”™è¯¯å¤„ç†å®Œå–„
   - âœ… æ•°æ®åº“æ“ä½œå®‰å…¨

3. **é…ç½®ç®¡ç†** (`app/core/config.py`)
   - âœ… ç¯å¢ƒå˜é‡åŠ è½½
   - âœ… ç±»å‹éªŒè¯ï¼ˆPydanticï¼‰
   - âœ… é»˜è®¤å€¼è®¾ç½®åˆç†

---

### éœ€è¦æ”¹è¿›çš„ç»„ä»¶ âš ï¸

1. **MetaGPTRunner é”™è¯¯å¤„ç†**
   - âš ï¸ éœ€è¦æ›´å¤šè¾¹ç•Œæƒ…å†µæµ‹è¯•
   - âš ï¸ LLM API å¤±è´¥åœºæ™¯
   - âš ï¸ ä»»åŠ¡è¶…æ—¶å¤„ç†

2. **WebSocket ç¨³å®šæ€§**
   - âš ï¸ å¤§é‡å¹¶å‘è¿æ¥æµ‹è¯•
   - âš ï¸ ç½‘ç»œä¸­æ–­æ¢å¤
   - âš ï¸ æ¶ˆæ¯ä¸¢å¤±å¤„ç†

3. **å¹¶å‘ä»»åŠ¡æ‰§è¡Œ**
   - âš ï¸ èµ„æºç«äº‰æµ‹è¯•
   - âš ï¸ ä»»åŠ¡å–æ¶ˆçš„è¾¹ç•Œæƒ…å†µ
   - âš ï¸ å†…å­˜æ³„æ¼æ£€æµ‹

4. **æ•°æ®åº“è¿ç§»**
   - âš ï¸ éœ€è¦è‡ªåŠ¨åŒ–è¿ç§»æµ‹è¯•
   - âš ï¸ å›æ»šæµ‹è¯•

---

## ğŸ› ï¸ æµ‹è¯•æ”¹è¿›å»ºè®®

### 1. å¢åŠ é›†æˆæµ‹è¯•

**å½“å‰çŠ¶æ€**ï¼šæœ‰åŸºç¡€çš„ E2E æµ‹è¯•

**å»ºè®®**ï¼š
- æ·»åŠ æ›´å¤šç«¯åˆ°ç«¯åœºæ™¯
- æµ‹è¯•çœŸå®çš„å¤šä»»åŠ¡å¹¶å‘åœºæ™¯
- æµ‹è¯•é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡

### 2. æ€§èƒ½æµ‹è¯•

**å»ºè®®æ·»åŠ **ï¼š
- ä»»åŠ¡æ‰§è¡Œæ—¶é—´åŸºå‡†æµ‹è¯•
- å¹¶å‘ä»»åŠ¡æ•°é‡é™åˆ¶æµ‹è¯•
- æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½æµ‹è¯•
- WebSocket æ¶ˆæ¯ååé‡æµ‹è¯•

### 3. å‹åŠ›æµ‹è¯•

**å»ºè®®æ·»åŠ **ï¼š
- å¤§é‡ä»»åŠ¡åŒæ—¶åˆ›å»º
- å¤§é‡ WebSocket è¿æ¥
- æ•°æ®åº“è¿æ¥æ± å‹åŠ›æµ‹è¯•

### 4. é”™è¯¯æ¢å¤æµ‹è¯•

**å»ºè®®æ·»åŠ **ï¼š
- æ•°æ®åº“è¿æ¥ä¸­æ–­æ¢å¤
- WebSocket æ–­çº¿é‡è¿
- ä»»åŠ¡æ‰§è¡Œå¤±è´¥åçš„æ¸…ç†

---

## ğŸ“ æµ‹è¯•æ‰§è¡Œå‘½ä»¤å‚è€ƒ

### å¿«é€Ÿæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest tests/

# è¿è¡Œå¹¶æ˜¾ç¤ºè¦†ç›–ç‡
pytest tests/ --cov=app --cov-report=term

# åªè¿è¡Œå¤±è´¥çš„æµ‹è¯•
pytest tests/ --lf

# è¿è¡Œä¸Šæ¬¡å¤±è´¥çš„æµ‹è¯•
pytest tests/ --ff
```

### è¯¦ç»†æµ‹è¯•

```bash
# è¯¦ç»†è¾“å‡º + å®Œæ•´é”™è¯¯ä¿¡æ¯
pytest tests/ -v --tb=long

# åªæ˜¾ç¤ºå¤±è´¥æµ‹è¯•
pytest tests/ -v --tb=short -x

# å¹¶è¡Œè¿è¡Œï¼ˆå¦‚æœå®‰è£…äº† pytest-xdistï¼‰
pytest tests/ -n auto
```

### ç‰¹å®šæµ‹è¯•

```bash
# è¿è¡Œç‰¹å®šæ–‡ä»¶
pytest tests/test_models.py

# è¿è¡Œç‰¹å®šæµ‹è¯•ç±»
pytest tests/test_services.py::TestTaskService

# è¿è¡Œç‰¹å®šæµ‹è¯•å‡½æ•°
pytest tests/test_services.py::TestTaskService::test_create_task

# è¿è¡ŒåŒ¹é…æ¨¡å¼çš„æµ‹è¯•
pytest tests/ -k "test_create"
```

---

## ğŸ“Š æµ‹è¯•æŠ¥å‘Šç”Ÿæˆ

### HTML è¦†ç›–ç‡æŠ¥å‘Š

```bash
pytest tests/ --cov=app --cov-report=html
open htmlcov/index.html
```

### JSON è¦†ç›–ç‡æŠ¥å‘Š

```bash
pytest tests/ --cov=app --cov-report=json
# ç”Ÿæˆ coverage.json
```

### XML è¦†ç›–ç‡æŠ¥å‘Šï¼ˆCI/CD ä½¿ç”¨ï¼‰

```bash
pytest tests/ --cov=app --cov-report=xml
# ç”Ÿæˆ coverage.xml
```

---

## ğŸ¯ æ€»ç»“

### æµ‹è¯•è¦†ç›–æƒ…å†µ

âœ… **å·²è¦†ç›–**ï¼š
- ä»»åŠ¡ CRUD æ“ä½œ
- äº‹ä»¶æ—¥å¿—æŒä¹…åŒ–
- ArtifactStore ç‰ˆæœ¬æ§åˆ¶
- WebSocket åŸºæœ¬åŠŸèƒ½
- MetaGPTRunner æ ¸å¿ƒæµç¨‹
- å¹¶å‘ä»»åŠ¡æ‰§è¡Œ

âš ï¸ **éœ€è¦åŠ å¼º**ï¼š
- é”™è¯¯å¤„ç†å’Œè¾¹ç•Œæƒ…å†µ
- æ€§èƒ½æµ‹è¯•
- å‹åŠ›æµ‹è¯•
- é•¿æ—¶é—´è¿è¡Œæµ‹è¯•

### å¯é æ€§è¯„çº§

| ç»„ä»¶ | å¯é æ€§ | è¯´æ˜ |
|------|--------|------|
| æ•°æ®æ¨¡å‹ | â­â­â­â­â­ | å®Œæ•´ä¸”ç¨³å®š |
| æœåŠ¡å±‚ | â­â­â­â­ | é€»è¾‘æ¸…æ™°ï¼Œé”™è¯¯å¤„ç†å®Œå–„ |
| API å±‚ | â­â­â­â­ | RESTful è®¾è®¡è‰¯å¥½ |
| MetaGPTRunner | â­â­â­ | æ ¸å¿ƒåŠŸèƒ½ç¨³å®šï¼Œéœ€è¦æ›´å¤šè¾¹ç•Œæµ‹è¯• |
| WebSocket | â­â­â­ | åŸºæœ¬åŠŸèƒ½æ­£å¸¸ï¼Œéœ€è¦å‹åŠ›æµ‹è¯• |
| å¹¶å‘æ‰§è¡Œ | â­â­â­ | æ”¯æŒå¤šä»»åŠ¡ï¼Œéœ€è¦æ›´å¤šèµ„æºæµ‹è¯• |

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³æ‰§è¡Œ**ï¼šè¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶å¹¶æŸ¥çœ‹ç»“æœ
2. **çŸ­æœŸæ”¹è¿›**ï¼šå¢åŠ é”™è¯¯å¤„ç†æµ‹è¯•å’Œè¾¹ç•Œæƒ…å†µæµ‹è¯•
3. **ä¸­æœŸæ”¹è¿›**ï¼šæ·»åŠ æ€§èƒ½æµ‹è¯•å’Œå‹åŠ›æµ‹è¯•
4. **é•¿æœŸæ”¹è¿›**ï¼šå»ºç«‹æŒç»­é›†æˆï¼ˆCIï¼‰æµç¨‹

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**ï¼š2024-01-01  
**æµ‹è¯•æ¡†æ¶ç‰ˆæœ¬**ï¼špytest 7.4.3  
**è¦†ç›–ç‡å·¥å…·**ï¼špytest-cov

