# MGX Engine å…¨æ ˆåº”ç”¨æ¶æ„æ–‡æ¡£

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
3. [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
4. [æ ¸å¿ƒæ¨¡å—](#æ ¸å¿ƒæ¨¡å—)
5. [API ç«¯ç‚¹](#api-ç«¯ç‚¹)
6. [æ•°æ®æµ](#æ•°æ®æµ)
7. [å®æ—¶é€šä¿¡](#å®æ—¶é€šä¿¡)
8. [å¯è§‚æµ‹æ€§](#å¯è§‚æµ‹æ€§)
9. [éƒ¨ç½²æ¶æ„](#éƒ¨ç½²æ¶æ„)
10. [æ‰©å±•æ€§è®¾è®¡](#æ‰©å±•æ€§è®¾è®¡)

---

## æ¦‚è¿°

MGX Engine æ˜¯ä¸€ä¸ªåŸºäº MetaGPT çš„å¤šæ™ºèƒ½ä½“ç³»ç»Ÿå…¨æ ˆåº”ç”¨ï¼Œé‡‡ç”¨å‰åç«¯åˆ†ç¦»æ¶æ„ï¼Œæ”¯æŒå®æ—¶ä»»åŠ¡æ‰§è¡Œã€äº‹ä»¶æµå¼ä¼ è¾“å’Œå®Œæ•´çš„å¯è§‚æµ‹æ€§ã€‚

### æ ¸å¿ƒç‰¹æ€§

- âœ… **å¤šæ™ºèƒ½ä½“åä½œ**ï¼šProductManagerã€Architectã€Engineerã€Debugger ååŒå·¥ä½œ
- âœ… **å®æ—¶äº‹ä»¶æµ**ï¼šWebSocket å®æ—¶æ¨é€ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€å’Œäº‹ä»¶
- âœ… **ä»»åŠ¡ç®¡ç†**ï¼šå®Œæ•´çš„ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆåˆ›å»ºã€æ‰§è¡Œã€ç›‘æ§ã€å®Œæˆï¼‰
- âœ… **ä»£ç ç”Ÿæˆä¸æ‰§è¡Œ**ï¼šè‡ªåŠ¨ç”Ÿæˆä»£ç å¹¶å®‰å…¨æ‰§è¡Œï¼Œæ”¯æŒç‰ˆæœ¬è·Ÿè¸ª
- âœ… **å¯è§‚æµ‹æ€§**ï¼šç»“æ„åŒ–æ—¥å¿—ã€Prometheus æŒ‡æ ‡ã€ä»»åŠ¡æŒ‡æ ‡è¿½è¸ª
- âœ… **å¹¶å‘æ‰§è¡Œ**ï¼šæ”¯æŒå¤šä»»åŠ¡å¹¶å‘æ‰§è¡Œï¼Œå…±äº« LLM API é™æµå™¨
- âœ… **æ•°æ®åº“æŒä¹…åŒ–**ï¼šPostgreSQL/SQLite æ”¯æŒï¼Œå®Œæ•´çš„æ•°æ®æ¨¡å‹

---

## æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯å±‚ (Frontend)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   React UI   â”‚  â”‚  WebSocket   â”‚  â”‚   Zustand    â”‚      â”‚
â”‚  â”‚  ç»„ä»¶åº“      â”‚  â”‚  å®æ—¶è¿æ¥     â”‚  â”‚  çŠ¶æ€ç®¡ç†    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ HTTP/WebSocket
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API å±‚ (FastAPI)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  REST API    â”‚  â”‚  WebSocket   â”‚  â”‚   Metrics    â”‚      â”‚
â”‚  â”‚  /api/tasks  â”‚  â”‚  /ws/tasks   â”‚  â”‚  /metrics    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æœåŠ¡å±‚ (Service Layer)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ TaskService  â”‚  â”‚ EventService â”‚  â”‚ArtifactServiceâ”‚     â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ ¸å¿ƒå¼•æ“å±‚ (Core Engine Layer)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚MetaGPTRunner â”‚  â”‚AgentSimulatorâ”‚  â”‚LLMRateLimiterâ”‚      â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚StructuredLog â”‚  â”‚  Metrics     â”‚  â”‚  DB Utils    â”‚      â”‚
â”‚  â”‚              â”‚  â”‚  Collector   â”‚  â”‚              â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•°æ®å±‚ (Data Layer)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   Task       â”‚  â”‚  EventLog    â”‚  â”‚ ArtifactStoreâ”‚      â”‚
â”‚  â”‚   Model      â”‚  â”‚   Model      â”‚  â”‚    Model     â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                            â”‚                                 â”‚
â”‚                            â–¼                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         PostgreSQL (Supabase) / SQLite               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åˆ†å±‚è¯´æ˜

#### 1. **å‰ç«¯å±‚ (Frontend Layer)**
- **æŠ€æœ¯æ ˆ**ï¼šReact + TypeScript + Vite + TailwindCSS
- **çŠ¶æ€ç®¡ç†**ï¼šZustand
- **å®æ—¶é€šä¿¡**ï¼šWebSocket
- **è·¯ç”±**ï¼šReact Router

#### 2. **API å±‚ (API Layer)**
- **æ¡†æ¶**ï¼šFastAPI
- **åŠŸèƒ½**ï¼š
  - RESTful API ç«¯ç‚¹
  - WebSocket å®æ—¶é€šä¿¡
  - Prometheus æŒ‡æ ‡ç«¯ç‚¹
  - CORS ä¸­é—´ä»¶
  - è¯·æ±‚éªŒè¯ï¼ˆPydanticï¼‰

#### 3. **æœåŠ¡å±‚ (Service Layer)**
- **èŒè´£**ï¼šä¸šåŠ¡é€»è¾‘å°è£…
- **æ¨¡å—**ï¼š
  - `TaskService`ï¼šä»»åŠ¡ç®¡ç†
  - `EventService`ï¼šäº‹ä»¶æŸ¥è¯¢
  - `ArtifactService`ï¼šä»£ç æ–‡ä»¶ç®¡ç†
  - `CodeEditService`ï¼šä»£ç ç¼–è¾‘

#### 4. **æ ¸å¿ƒå¼•æ“å±‚ (Core Engine Layer)**
- **MetaGPTRunner**ï¼šå¤šæ™ºèƒ½ä½“æ‰§è¡Œå¼•æ“
- **AgentSimulator**ï¼šæ™ºèƒ½ä½“æ¨¡æ‹Ÿå™¨ï¼ˆPMã€Architectã€Engineerã€Debuggerï¼‰
- **LLMRateLimiter**ï¼šLLM API é™æµå™¨ï¼ˆå…±äº«ï¼‰
- **StructuredLog**ï¼šç»“æ„åŒ–æ—¥å¿—
- **MetricsCollector**ï¼šæŒ‡æ ‡æ”¶é›†å™¨

#### 5. **æ•°æ®å±‚ (Data Layer)**
- **ORM**ï¼šSQLAlchemy
- **æ•°æ®åº“**ï¼šPostgreSQL (Supabase) / SQLite
- **æ¨¡å‹**ï¼šTaskã€EventLogã€ArtifactStoreã€AgentRun

---

## æŠ€æœ¯æ ˆ

### åç«¯æŠ€æœ¯æ ˆ

| ç±»åˆ« | æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|------|
| **Web æ¡†æ¶** | FastAPI | 0.104.1 | RESTful API å’Œ WebSocket |
| **ASGI æœåŠ¡å™¨** | Uvicorn | 0.24.0 | å¼‚æ­¥ HTTP æœåŠ¡å™¨ |
| **ORM** | SQLAlchemy | â‰¥2.0.36 | æ•°æ®åº“ ORM |
| **æ•°æ®åº“** | PostgreSQL/SQLite | - | æ•°æ®æŒä¹…åŒ– |
| **æ•°æ®éªŒè¯** | Pydantic | â‰¥2.8.0 | è¯·æ±‚/å“åº”éªŒè¯ |
| **é…ç½®ç®¡ç†** | python-dotenv | 1.0.0 | ç¯å¢ƒå˜é‡ç®¡ç† |
| **æ—¥å¿—** | structlog | â‰¥24.1.0 | ç»“æ„åŒ–æ—¥å¿— |
| **ç›‘æ§** | prometheus-client | â‰¥0.19.0 | Prometheus æŒ‡æ ‡ |
| **æµ‹è¯•** | pytest | 7.4.3 | å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯• |

### å‰ç«¯æŠ€æœ¯æ ˆ

| ç±»åˆ« | æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|------|
| **æ¡†æ¶** | React | 18+ | UI æ¡†æ¶ |
| **è¯­è¨€** | TypeScript | 5+ | ç±»å‹å®‰å…¨ |
| **æ„å»ºå·¥å…·** | Vite | 5+ | å¿«é€Ÿæ„å»º |
| **æ ·å¼** | TailwindCSS | 3.4.0 | å®ç”¨ CSS æ¡†æ¶ |
| **UI ç»„ä»¶** | shadcn/ui | - | å¯å¤ç”¨ç»„ä»¶åº“ |
| **çŠ¶æ€ç®¡ç†** | Zustand | - | è½»é‡çº§çŠ¶æ€ç®¡ç† |
| **HTTP å®¢æˆ·ç«¯** | Axios | - | API è¯·æ±‚ |
| **è·¯ç”±** | react-router-dom | - | å‰ç«¯è·¯ç”± |

---

## æ ¸å¿ƒæ¨¡å—

### 1. MetaGPTRunnerï¼ˆå¤šæ™ºèƒ½ä½“æ‰§è¡Œå¼•æ“ï¼‰

**ä½ç½®**ï¼š`app/core/metagpt_runner.py`

**èŒè´£**ï¼š
- ç®¡ç†ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸ
- åè°ƒå¤šä¸ªæ™ºèƒ½ä½“æ‰§è¡Œ
- äº‹ä»¶æµå¼ä¼ è¾“
- æ•°æ®åº“æŒä¹…åŒ–

**æ ¸å¿ƒæ–¹æ³•**ï¼š
```python
async def start_task_async(
    task_id: str,
    requirement: str,
    on_event: Optional[Callable] = None,
    test_mode: Optional[bool] = None
) -> None
```

**ç‰¹æ€§**ï¼š
- âœ… å¹¶å‘ä»»åŠ¡æ‰§è¡Œï¼ˆæ¯ä¸ªä»»åŠ¡ç‹¬ç«‹ asyncio.Taskï¼‰
- âœ… äº‹ä»¶é˜Ÿåˆ—éš”ç¦»ï¼ˆæ¯ä¸ªä»»åŠ¡ç‹¬ç«‹ Queueï¼‰
- âœ… è‡ªåŠ¨æ¸…ç†ï¼ˆä»»åŠ¡å®Œæˆåè‡ªåŠ¨æ¸…ç†èµ„æºï¼‰
- âœ… ä»»åŠ¡å–æ¶ˆæ”¯æŒ

### 2. AgentSimulatorï¼ˆæ™ºèƒ½ä½“æ¨¡æ‹Ÿå™¨ï¼‰

**ä½ç½®**ï¼š`app/core/metagpt_runner.py` (AgentSimulator ç±»)

**æ™ºèƒ½ä½“è§’è‰²**ï¼š

#### ProductManager (PM)
- **èŒè´£**ï¼šåˆ†æéœ€æ±‚ï¼Œç”Ÿæˆ PRD
- **è¾“å‡º**ï¼š`docs/PRD.md`
- **äº‹ä»¶**ï¼šAGENT_START, MESSAGE (thinking/drafting), AGENT_COMPLETE

#### Architect
- **èŒè´£**ï¼šç³»ç»Ÿè®¾è®¡ï¼Œç”Ÿæˆè®¾è®¡æ–‡æ¡£
- **è¾“å‡º**ï¼š`docs/design.md`
- **ç‰¹æ€§**ï¼šå¯å¹¶å‘è¯»å– PM è¾“å‡ºï¼ˆæµå¼ä¾èµ–ï¼‰

#### Engineer
- **èŒè´£**ï¼šä»£ç å®ç°å’Œæ‰§è¡Œ
- **è¾“å‡º**ï¼š`src/main.py` ç­‰ä»£ç æ–‡ä»¶
- **ç‰¹æ€§**ï¼šä»£ç æ‰§è¡Œã€å®æ—¶ stdout/stderr æµå¼ä¼ è¾“

#### Debugger
- **èŒè´£**ï¼šé”™è¯¯ä¿®å¤å’Œé‡æ–°æ‰§è¡Œ
- **ç‰¹æ€§**ï¼šç”Ÿæˆ diffã€ç‰ˆæœ¬å¢é‡

### 3. LLMRateLimiterï¼ˆLLM API é™æµå™¨ï¼‰

**ä½ç½®**ï¼š`app/core/llm_rate_limiter.py`

**ç‰¹æ€§**ï¼š
- âœ… å•ä¾‹æ¨¡å¼ï¼ˆå…¨å±€å…±äº«ï¼‰
- âœ… ä¿¡å·é‡æ§åˆ¶å¹¶å‘æ•°
- âœ… è‡ªåŠ¨æŒ‡æ ‡è®°å½•
- âœ… 429 é”™è¯¯å¤„ç†

**é…ç½®**ï¼š
```python
LLM_MAX_CONCURRENCY=3  # æœ€å¤§å¹¶å‘ LLM è°ƒç”¨æ•°
```

### 4. ç»“æ„åŒ–æ—¥å¿—ç³»ç»Ÿ

**ä½ç½®**ï¼š`app/core/structured_logging.py`

**ç‰¹æ€§**ï¼š
- âœ… JSON æ ¼å¼è¾“å‡º
- âœ… AgentStepLogger ä¸Šä¸‹æ–‡ç®¡ç†å™¨
- âœ… è‡ªåŠ¨è®°å½•æŒç»­æ—¶é—´ã€token æˆæœ¬ã€çŠ¶æ€

**ç¤ºä¾‹**ï¼š
```json
{
  "event": "agent_step_completed",
  "agent_name": "ProductManager",
  "step_name": "run_pm",
  "task_id": "xxx",
  "status": "completed",
  "duration_seconds": 2.5,
  "token_cost": 0.0001,
  "timestamp": "2024-01-01T10:00:00Z"
}
```

### 5. Prometheus æŒ‡æ ‡ç³»ç»Ÿ

**ä½ç½®**ï¼š`app/core/metrics.py`

**æŒ‡æ ‡ç±»å‹**ï¼š

| æŒ‡æ ‡åç§° | ç±»å‹ | æ ‡ç­¾ | è¯´æ˜ |
|---------|------|------|------|
| `mgx_tasks_total` | Counter | status | ä»»åŠ¡æ€»æ•°ï¼ˆæŒ‰çŠ¶æ€ï¼‰ |
| `mgx_tasks_active` | Gauge | - | å½“å‰æ´»è·ƒä»»åŠ¡æ•° |
| `mgx_task_duration_seconds` | Histogram | status | ä»»åŠ¡æ‰§è¡Œæ—¶é—´ |
| `mgx_events_total` | Counter | event_type, agent_role | äº‹ä»¶æ€»æ•° |
| `mgx_artifacts_total` | Counter | agent_role, file_extension | Artifact æ€»æ•° |
| `mgx_agent_steps_total` | Counter | agent_name, step_name, status | Agent æ­¥éª¤æ€»æ•° |
| `mgx_agent_step_duration_seconds` | Histogram | agent_name, step_name | Agent æ­¥éª¤æ‰§è¡Œæ—¶é—´ |
| `mgx_agent_token_cost_total` | Counter | agent_name, step_name | Token æˆæœ¬ç´¯è®¡ |
| `mgx_llm_calls_total` | Counter | status | LLM è°ƒç”¨æ€»æ•° |
| `mgx_llm_rate_limit_hits_total` | Counter | - | é™æµæ¬¡æ•° |
| `mgx_llm_concurrent_calls` | Gauge | - | å½“å‰å¹¶å‘ LLM è°ƒç”¨æ•° |

**è®¿é—®ç«¯ç‚¹**ï¼š`GET /metrics`

---

## API ç«¯ç‚¹

### REST API

#### ä»»åŠ¡ç®¡ç†

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | è¯·æ±‚ä½“ | å“åº” |
|------|------|------|--------|------|
| `POST` | `/api/tasks` | åˆ›å»ºä»»åŠ¡ | `{title, input_prompt}` | `TaskResponse` |
| `GET` | `/api/tasks` | åˆ—è¡¨ä»»åŠ¡ | Query: `page`, `page_size`, `status` | `List[TaskResponse]` |
| `GET` | `/api/tasks/{task_id}` | è·å–ä»»åŠ¡è¯¦æƒ… | - | `TaskResponse` |
| `PUT` | `/api/tasks/{task_id}` | æ›´æ–°ä»»åŠ¡ | `{title?, status?, result_summary?}` | `TaskResponse` |
| `DELETE` | `/api/tasks/{task_id}` | åˆ é™¤ä»»åŠ¡ | - | `204 No Content` |
| `POST` | `/api/tasks/{task_id}/run` | å¯åŠ¨ä»»åŠ¡æ‰§è¡Œ | - | `202 Accepted` |
| `POST` | `/api/tasks/{task_id}/stop` | åœæ­¢ä»»åŠ¡ | - | `200 OK` |
| `GET` | `/api/tasks/{task_id}/state` | è·å–ä»»åŠ¡çŠ¶æ€ | - | `TaskState` |
| `GET` | `/api/tasks/{task_id}/events` | è·å–ä»»åŠ¡äº‹ä»¶ | Query: `since_event_id?` | `List[Event]` |
| `GET` | `/api/tasks/{task_id}/metrics` | è·å–ä»»åŠ¡æŒ‡æ ‡ | - | `TaskMetrics` |
| `GET` | `/api/tasks/{task_id}/timeline` | è·å–æ—¶é—´çº¿ | Query: `limit?`, `offset?` | `TimelineResponse` |
| `POST` | `/api/tasks/{task_id}/edit` | ç¼–è¾‘ä»£ç  | `{file_path, instruction}` | `EditResponse` |
| `GET` | `/api/tasks/active` | è·å–æ´»è·ƒä»»åŠ¡åˆ—è¡¨ | - | `List[str]` |

#### Artifact ç®¡ç†

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | è¯·æ±‚ä½“ | å“åº” |
|------|------|------|--------|------|
| `GET` | `/api/artifacts/{task_id}` | åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶ | - | `ArtifactListResponse` |
| `GET` | `/api/artifacts/{task_id}/{file_path}/versions` | è·å–æ–‡ä»¶ç‰ˆæœ¬åˆ—è¡¨ | - | `ArtifactVersionsResponse` |
| `GET` | `/api/artifacts/{task_id}/{file_path}` | è·å–æ–‡ä»¶å†…å®¹ | Query: `version?` | `ArtifactContentResponse` |

#### ç³»ç»Ÿç«¯ç‚¹

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | å“åº” |
|------|------|------|------|
| `GET` | `/` | æ ¹ç«¯ç‚¹ | `{message, version, docs}` |
| `GET` | `/health` | å¥åº·æ£€æŸ¥ | `{status, database}` |
| `GET` | `/metrics` | Prometheus æŒ‡æ ‡ | `text/plain` |
| `GET` | `/docs` | Swagger UI | HTML |
| `GET` | `/openapi.json` | OpenAPI è§„èŒƒ | JSON |

### WebSocket API

#### ä»»åŠ¡äº‹ä»¶æµ

**ç«¯ç‚¹**ï¼š`/ws/tasks/{task_id}`

**è¿æ¥æµç¨‹**ï¼š
1. å‰ç«¯è¿æ¥ WebSocket
2. å¦‚æœä»»åŠ¡æœªè¿è¡Œï¼Œè‡ªåŠ¨å¯åŠ¨ä»»åŠ¡
3. æŒç»­æ¥æ”¶äº‹ä»¶æ¶ˆæ¯

**æ¶ˆæ¯æ ¼å¼**ï¼š

**è¿æ¥æˆåŠŸ**ï¼š
```json
{
  "type": "connected",
  "data": {
    "task_id": "xxx",
    "message": "WebSocket connected"
  }
}
```

**äº‹ä»¶æ¶ˆæ¯**ï¼š
```json
{
  "type": "event",
  "data": {
    "event_id": 1,
    "task_id": "xxx",
    "timestamp": "2024-01-01T10:00:00Z",
    "agent_role": "ProductManager",
    "event_type": "MESSAGE",
    "payload": {
      "message": "Thinking about requirements...",
      "visual_type": "MESSAGE",
      "status": "thinking"
    }
  }
}
```

**çŠ¶æ€æ›´æ–°**ï¼š
```json
{
  "type": "state",
  "data": {
    "task_id": "xxx",
    "status": "RUNNING",
    "progress": 0.5,
    "current_agent": "Engineer",
    "last_message": "Code execution successful"
  }
}
```

**é”™è¯¯æ¶ˆæ¯**ï¼š
```json
{
  "type": "error",
  "data": {
    "message": "Error description"
  }
}
```

**è‡ªåŠ¨å…³é—­**ï¼š
- ä»»åŠ¡çŠ¶æ€å˜ä¸º `SUCCEEDED`ã€`FAILED` æˆ– `CANCELLED` æ—¶è‡ªåŠ¨å…³é—­è¿æ¥

---

## æ•°æ®æµ

### ä»»åŠ¡åˆ›å»ºå’Œæ‰§è¡Œæµç¨‹

```
1. å‰ç«¯ POST /api/tasks
   â†“
2. TaskService.create_task()
   â†“
3. æ•°æ®åº“æ’å…¥ Task (status=PENDING)
   â†“
4. è¿”å› TaskResponse
   â†“
5. å‰ç«¯ POST /api/tasks/{id}/run
   â†“
6. TaskService.start_task()
   â†“
7. MetaGPTRunner.start_task_async()
   â†“
8. åˆ›å»º asyncio.Task
   â†“
9. AgentSimulator æ‰§è¡Œæµç¨‹ï¼š
   â”œâ”€ ProductManager.run_pm()
   â”‚  â”œâ”€ ç”Ÿæˆ PRD
   â”‚  â”œâ”€ ä¿å­˜ ArtifactStore
   â”‚  â””â”€ å‘å‡ºäº‹ä»¶
   â”œâ”€ Architect.run_architect()
   â”‚  â”œâ”€ è¯»å– PM è¾“å‡ºï¼ˆå¹¶å‘ï¼‰
   â”‚  â”œâ”€ ç”Ÿæˆè®¾è®¡æ–‡æ¡£
   â”‚  â””â”€ å‘å‡ºäº‹ä»¶
   â”œâ”€ Engineer.run_engineer()
   â”‚  â”œâ”€ ç”Ÿæˆä»£ç 
   â”‚  â”œâ”€ æ‰§è¡Œä»£ç ï¼ˆæµå¼è¾“å‡ºï¼‰
   â”‚  â””â”€ å‘å‡ºäº‹ä»¶
   â””â”€ Debugger.run_debugger() (å¦‚æœéœ€è¦)
      â”œâ”€ ä¿®å¤ä»£ç 
      â”œâ”€ ç”Ÿæˆ diff
      â””â”€ é‡æ–°æ‰§è¡Œ
   â†“
10. äº‹ä»¶æµï¼š
    â”œâ”€ å†…å­˜é˜Ÿåˆ— (_event_queues)
    â”œâ”€ æ•°æ®åº“æŒä¹…åŒ– (EventLog)
    â””â”€ WebSocket æ¨é€
   â†“
11. ä»»åŠ¡å®Œæˆï¼š
    â”œâ”€ æ›´æ–° Task.status = SUCCEEDED
    â”œâ”€ ä¿å­˜ result_summary
    â””â”€ å…³é—­ WebSocket
```

### äº‹ä»¶æµå¼ä¼ è¾“

```
AgentSimulator
    â†“ emit_event_async()
MetaGPTRunner._emit_event_async()
    â”œâ”€â†’ å†…å­˜é˜Ÿåˆ— (asyncio.Queue)
    â”œâ”€â†’ æ•°æ®åº“æŒä¹…åŒ– (EventLog)
    â””â”€â†’ WebSocket æ¨é€
        â†“
å‰ç«¯æ¥æ”¶å¹¶æ›´æ–° UI
```

---

## å®æ—¶é€šä¿¡

### WebSocket æ¶æ„

**è¿æ¥ç®¡ç†**ï¼š
- æ¯ä¸ªä»»åŠ¡æœ‰ç‹¬ç«‹çš„ `asyncio.Queue` ç”¨äºäº‹ä»¶ä¼ è¾“
- æ”¯æŒå¤šä¸ª WebSocket è¿æ¥è®¢é˜…åŒä¸€ä»»åŠ¡
- ä»»åŠ¡å®Œæˆåè‡ªåŠ¨å…³é—­æ‰€æœ‰è¿æ¥

**äº‹ä»¶è®¢é˜…**ï¼š
```python
# åç«¯ï¼šäº‹ä»¶å…¥é˜Ÿ
await self._put_event_to_queue(task_id, event)

# WebSocket å¤„ç†ï¼šä»é˜Ÿåˆ—è¯»å–å¹¶æ¨é€
async for event in self._read_events_from_queue(task_id):
    await websocket.send_json({
        "type": "event",
        "data": event.to_dict()
    })
```

**é‡è¿æœºåˆ¶**ï¼š
- å‰ç«¯è‡ªåŠ¨é‡è¿ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
- æ”¯æŒæ–­çº¿é‡è¿åç»§ç»­æ¥æ”¶äº‹ä»¶

---

## å¯è§‚æµ‹æ€§

### ç»“æ„åŒ–æ—¥å¿—

**é…ç½®**ï¼š`app/core/structured_logging.py`

**æ—¥å¿—æ ¼å¼**ï¼šJSON

**å…³é”®æ—¥å¿—äº‹ä»¶**ï¼š
- `application_starting`ï¼šåº”ç”¨å¯åŠ¨
- `agent_step_started`ï¼šAgent æ­¥éª¤å¼€å§‹
- `agent_step_completed`ï¼šAgent æ­¥éª¤å®Œæˆ
- `agent_step_error`ï¼šAgent æ­¥éª¤é”™è¯¯

### Prometheus æŒ‡æ ‡

**ç«¯ç‚¹**ï¼š`GET /metrics`

**æŒ‡æ ‡ç±»å‹**ï¼š
- **Counter**ï¼šç´¯è®¡è®¡æ•°ï¼ˆä»»åŠ¡æ•°ã€äº‹ä»¶æ•°ã€LLM è°ƒç”¨æ•°ï¼‰
- **Gauge**ï¼šå½“å‰å€¼ï¼ˆæ´»è·ƒä»»åŠ¡æ•°ã€å¹¶å‘ LLM è°ƒç”¨æ•°ï¼‰
- **Histogram**ï¼šåˆ†å¸ƒï¼ˆä»»åŠ¡æŒç»­æ—¶é—´ã€Agent æ­¥éª¤æŒç»­æ—¶é—´ï¼‰

**Grafana é›†æˆ**ï¼š
```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'mgx-engine'
    static_configs:
      - targets: ['localhost:8000']
```

### ä»»åŠ¡æŒ‡æ ‡

**TaskMetrics ç±»**ï¼š
- ä»»åŠ¡æ€»æ—¶é•¿
- å„ Agent æ‰§è¡Œæ—¶é•¿
- å„é˜¶æ®µæ—¶é—´æˆ³

**è®¿é—®**ï¼š`GET /api/tasks/{task_id}/metrics`

---

## éƒ¨ç½²æ¶æ„

### å¼€å‘ç¯å¢ƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯ (Vite) â”‚  http://localhost:5173
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ HTTP/WebSocket
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FastAPI     â”‚  http://localhost:8000
â”‚ (Uvicorn)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SQLite     â”‚  ./mgx_engine.db
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç”Ÿäº§ç¯å¢ƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯ (Vercel)   â”‚  https://mgx-frontend.vercel.app
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ HTTPS/WebSocket
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FastAPI        â”‚  https://api.mgx.dev
â”‚  (Uvicorn/Gunicorn)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Supabase       â”‚  PostgreSQL
â”‚  (PostgreSQL)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Prometheus     â”‚  æŒ‡æ ‡æ”¶é›†
â”‚  + Grafana      â”‚  å¯è§†åŒ–
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Docker éƒ¨ç½²

**docker-compose.yml**ï¼š
```yaml
version: '3.8'
services:
  backend:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://user:pass@db:5432/mgx
      - SUPABASE_DB_URL=${SUPABASE_DB_URL}
    depends_on:
      - db
  
  db:
    image: postgres:15
    environment:
      - POSTGRES_DB=mgx
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
    volumes:
      - postgres_data:/var/lib/postgresql/data
  
  prometheus:
    image: prom/prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
```

---

## æ‰©å±•æ€§è®¾è®¡

### æ°´å¹³æ‰©å±•

**æ— çŠ¶æ€ API**ï¼š
- FastAPI åº”ç”¨æ— çŠ¶æ€ï¼Œå¯æ°´å¹³æ‰©å±•
- ä½¿ç”¨å…±äº«æ•°æ®åº“ï¼ˆPostgreSQLï¼‰

**ä»»åŠ¡åˆ†å‘**ï¼š
- å½“å‰ï¼šå•æœºå¹¶å‘ï¼ˆasyncio.Taskï¼‰
- æ‰©å±•ï¼šå¯é›†æˆ Celery + Redis å®ç°åˆ†å¸ƒå¼ä»»åŠ¡é˜Ÿåˆ—

### æ€§èƒ½ä¼˜åŒ–

**æ•°æ®åº“ä¼˜åŒ–**ï¼š
- ç´¢å¼•ï¼š`task_id`, `created_at`, `status`
- è¿æ¥æ± ï¼šSQLAlchemy è¿æ¥æ± é…ç½®

**ç¼“å­˜ç­–ç•¥**ï¼š
- ä»»åŠ¡çŠ¶æ€ç¼“å­˜ï¼ˆRedisï¼‰
- äº‹ä»¶æŸ¥è¯¢ç¼“å­˜

**å¼‚æ­¥å¤„ç†**ï¼š
- æ‰€æœ‰ I/O æ“ä½œå¼‚æ­¥åŒ–
- æ•°æ®åº“æ“ä½œä½¿ç”¨ `run_in_executor`

### å®‰å…¨è€ƒè™‘

**API è®¤è¯**ï¼š
- å½“å‰ï¼šæ— è®¤è¯ï¼ˆå¼€å‘é˜¶æ®µï¼‰
- æ‰©å±•ï¼šJWT Token è®¤è¯

**ä»£ç æ‰§è¡Œå®‰å…¨**ï¼š
- æ²™ç®±ç¯å¢ƒæ‰§è¡Œä»£ç 
- è¶…æ—¶æ§åˆ¶
- èµ„æºé™åˆ¶

**CORS é…ç½®**ï¼š
- ç”Ÿäº§ç¯å¢ƒé™åˆ¶å…è®¸çš„æº

---

## æ€»ç»“

MGX Engine æ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„å…¨æ ˆå¤šæ™ºèƒ½ä½“ç³»ç»Ÿï¼Œå…·å¤‡ï¼š

âœ… **å®Œæ•´çš„ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†**
âœ… **å®æ—¶äº‹ä»¶æµå¼ä¼ è¾“**
âœ… **å¤šæ™ºèƒ½ä½“åä½œæ‰§è¡Œ**
âœ… **ä»£ç ç”Ÿæˆä¸ç‰ˆæœ¬è·Ÿè¸ª**
âœ… **å…¨é¢çš„å¯è§‚æµ‹æ€§**
âœ… **é«˜å¹¶å‘æ”¯æŒ**
âœ… **ç”Ÿäº§å°±ç»ªçš„æ¶æ„**

**ä¸‹ä¸€æ­¥æ‰©å±•æ–¹å‘**ï¼š
1. æ·»åŠ ç”¨æˆ·è®¤è¯å’Œæˆæƒ
2. é›†æˆçœŸå®çš„ MetaGPT æ¡†æ¶
3. åˆ†å¸ƒå¼ä»»åŠ¡é˜Ÿåˆ—ï¼ˆCeleryï¼‰
4. å‰ç«¯ä»£ç ç¼–è¾‘å™¨é›†æˆ
5. ä»»åŠ¡æ¨¡æ¿å’Œé¢„è®¾
6. å›¢é˜Ÿåä½œåŠŸèƒ½

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0.0  
**æœ€åæ›´æ–°**ï¼š2024-01-01  
**ç»´æŠ¤è€…**ï¼šMGX Engine Team

