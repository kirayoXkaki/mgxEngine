# æµ‹è¯•ä¼˜åŒ–æŒ‡å—

## âš¡ æµ‹è¯•æ‰§è¡Œæ—¶é—´ä¼˜åŒ–

### é—®é¢˜
æµ‹è¯•è¿è¡Œæ—¶é—´å¤ªé•¿ï¼Œå½±å“å¼€å‘æ•ˆç‡ã€‚

### è§£å†³æ–¹æ¡ˆ

#### 1. å‡å°‘ sleep æ—¶é—´ âœ…

**å·²ä¼˜åŒ–**ï¼šå°†æ‰€æœ‰æµ‹è¯•ä¸­çš„ `time.sleep()` æ—¶é—´å‡å°‘ï¼š
- `time.sleep(0.5)` â†’ `time.sleep(0.2)` æˆ– `time.sleep(0.15)`
- `time.sleep(1.0)` â†’ `time.sleep(0.5)`
- `asyncio.sleep(0.2)` â†’ `asyncio.sleep(0.1)`

**å½±å“**ï¼šå‡å°‘çº¦ 50-70% çš„ç­‰å¾…æ—¶é—´

---

#### 2. ä½¿ç”¨ pytest-xdist å¹¶è¡Œæ‰§è¡Œ ğŸš€

**å®‰è£…**ï¼š
```bash
pip install pytest-xdist
```

**è¿è¡Œ**ï¼š
```bash
# è‡ªåŠ¨æ£€æµ‹ CPU æ ¸å¿ƒæ•°
pytest tests/ -n auto

# æŒ‡å®šå¹¶è¡Œæ•°
pytest tests/ -n 4
```

**é¢„æœŸåŠ é€Ÿ**ï¼š2-4xï¼ˆå–å†³äº CPU æ ¸å¿ƒæ•°ï¼‰

---

#### 3. ä½¿ç”¨ pytest-timeout é˜²æ­¢æŒ‚èµ· â±ï¸

**å·²é…ç½®**ï¼šåœ¨ `pytest.ini` ä¸­æ·»åŠ äº† `timeout = 300`

**è¿è¡Œ**ï¼š
```bash
pytest tests/ --timeout=300
```

---

#### 4. æ ‡è®°æ…¢é€Ÿæµ‹è¯• ğŸŒ

**å·²æ·»åŠ **ï¼š`@pytest.mark.slow` æ ‡è®°

**è·³è¿‡æ…¢é€Ÿæµ‹è¯•**ï¼š
```bash
# åªè¿è¡Œå¿«é€Ÿæµ‹è¯•
pytest tests/ -m "not slow"

# åªè¿è¡Œæ…¢é€Ÿæµ‹è¯•
pytest tests/ -m "slow"
```

---

#### 5. ä½¿ç”¨ -x å¿«é€Ÿå¤±è´¥ âš¡

**å·²é…ç½®**ï¼šåœ¨ `pytest.ini` ä¸­æ·»åŠ äº† `-x`ï¼ˆé‡åˆ°ç¬¬ä¸€ä¸ªå¤±è´¥å°±åœæ­¢ï¼‰

**æ‰‹åŠ¨ä½¿ç”¨**ï¼š
```bash
pytest tests/ -x  # é‡åˆ°ç¬¬ä¸€ä¸ªå¤±è´¥å°±åœæ­¢
pytest tests/ --maxfail=3  # é‡åˆ°3ä¸ªå¤±è´¥ååœæ­¢
```

---

#### 6. ä¼˜åŒ–æµ‹è¯•ç­‰å¾…é€»è¾‘ ğŸ”„

**æ”¹è¿›**ï¼š
- ä½¿ç”¨è½®è¯¢è€Œä¸æ˜¯å›ºå®š sleep
- å‡å°‘æœ€å¤§ç­‰å¾…æ—¶é—´ï¼ˆ5ç§’ â†’ 3ç§’ï¼‰
- ä½¿ç”¨æ›´çŸ­çš„è½®è¯¢é—´éš”ï¼ˆ0.2ç§’ â†’ 0.1ç§’ï¼‰

---

## ğŸ“Š æµ‹è¯•æ‰§è¡Œæ—¶é—´å¯¹æ¯”

### ä¼˜åŒ–å‰
- å®Œæ•´æµ‹è¯•å¥—ä»¶ï¼š~60-90 ç§’
- å•ä¸ªæµ‹è¯•æ–‡ä»¶ï¼š~5-10 ç§’

### ä¼˜åŒ–åï¼ˆé¢„æœŸï¼‰
- å®Œæ•´æµ‹è¯•å¥—ä»¶ï¼š~20-30 ç§’ï¼ˆä¸²è¡Œï¼‰æˆ– ~10-15 ç§’ï¼ˆå¹¶è¡Œï¼‰
- å•ä¸ªæµ‹è¯•æ–‡ä»¶ï¼š~2-5 ç§’

### ä½¿ç”¨å¹¶è¡Œæ‰§è¡Œ
```bash
# 4 æ ¸ CPUï¼Œé¢„æœŸåŠ é€Ÿ 3-4x
pytest tests/ -n 4
# é¢„æœŸæ—¶é—´ï¼š~15-20 ç§’
```

---

## ğŸ¯ æ¨èçš„æµ‹è¯•æ‰§è¡Œç­–ç•¥

### å¼€å‘æ—¶ï¼ˆå¿«é€Ÿåé¦ˆï¼‰
```bash
# åªè¿è¡Œå¿«é€Ÿæµ‹è¯•ï¼Œé‡åˆ°å¤±è´¥ç«‹å³åœæ­¢
pytest tests/ -m "not slow" -x

# æˆ–è¿è¡Œç‰¹å®šæ–‡ä»¶
pytest tests/test_models.py -v
```

### æäº¤å‰ï¼ˆå®Œæ•´æµ‹è¯•ï¼‰
```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼Œå¹¶è¡Œæ‰§è¡Œ
pytest tests/ -n auto

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
pytest tests/ -n auto --cov=app --cov-report=term
```

### CI/CDï¼ˆå®Œæ•´éªŒè¯ï¼‰
```bash
# å®Œæ•´æµ‹è¯• + è¦†ç›–ç‡
pytest tests/ -n auto --cov=app --cov-report=html --cov-report=xml
```

---

## ğŸ”§ å·²ä¿®å¤çš„æµ‹è¯•é—®é¢˜

### 1. AgentSimulator å·¥ä½œæµæµ‹è¯• âœ…

**é—®é¢˜**ï¼šä½¿ç”¨åŒæ­¥ `start_task()` ä½†å®é™…æ˜¯å¼‚æ­¥

**ä¿®å¤**ï¼š
- æ·»åŠ  `@pytest.mark.asyncio`
- ä½¿ç”¨ `await runner.start_task_async()`
- ä½¿ç”¨ `await asyncio.sleep()` æ›¿ä»£ `time.sleep()`

**æ–‡ä»¶**ï¼š`test_agent_simulator.py`

---

### 2. API æµ‹è¯•ç­‰å¾…æ—¶é—´ âœ…

**é—®é¢˜**ï¼šç­‰å¾…æ—¶é—´è¿‡é•¿ï¼Œæµ‹è¯•æ‰§è¡Œæ…¢

**ä¿®å¤**ï¼š
- å‡å°‘ `time.sleep()` æ—¶é—´
- æ”¾å®½æ–­è¨€æ¡ä»¶ï¼ˆå…è®¸ PENDING çŠ¶æ€ï¼‰
- ä¼˜åŒ–ç­‰å¾…é€»è¾‘

**æ–‡ä»¶**ï¼š`test_api_tasks_complete.py`, `test_metagpt_api.py`

---

### 3. MetaGPTRunner stop_task æµ‹è¯• âœ…

**é—®é¢˜**ï¼šä½¿ç”¨åŒæ­¥ `stop_task()` ä½†ä»»åŠ¡æ˜¯ç”¨ `start_task_async()` å¯åŠ¨çš„

**ä¿®å¤**ï¼š
- ä½¿ç”¨ `await runner.cancel_task()` æ›¿ä»£ `runner.stop_task()`
- æ·»åŠ  `@pytest.mark.asyncio`

**æ–‡ä»¶**ï¼š`test_metagpt_runner.py`

---

## ğŸ“ æµ‹è¯•æ‰§è¡Œå‘½ä»¤å‚è€ƒ

### å¿«é€Ÿæµ‹è¯•ï¼ˆå¼€å‘æ—¶ï¼‰
```bash
# åªè¿è¡Œå¿«é€Ÿæµ‹è¯•ï¼Œå¿«é€Ÿå¤±è´¥
pytest tests/ -m "not slow" -x -v

# è¿è¡Œç‰¹å®šæ¨¡å—
pytest tests/test_models.py tests/test_services.py -v
```

### å®Œæ•´æµ‹è¯•ï¼ˆæäº¤å‰ï¼‰
```bash
# å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰æµ‹è¯•
pytest tests/ -n auto -v

# å¸¦è¦†ç›–ç‡
pytest tests/ -n auto --cov=app --cov-report=term
```

### è°ƒè¯•å¤±è´¥æµ‹è¯•
```bash
# è¿è¡Œä¸Šæ¬¡å¤±è´¥çš„æµ‹è¯•
pytest tests/ --lf -v

# è¿è¡Œç‰¹å®šå¤±è´¥çš„æµ‹è¯•
pytest tests/test_agent_simulator.py::TestMultiAgentWorkflow::test_simulate_workflow_pm_to_architect_to_engineer -v --tb=long
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¹¶è¡Œæ‰§è¡Œé™åˆ¶**ï¼š
   - æŸäº›æµ‹è¯•å¯èƒ½ä¾èµ–å…±äº«èµ„æº
   - å¦‚æœå‡ºç°ç«æ€æ¡ä»¶ï¼Œå¯èƒ½éœ€è¦ä¸²è¡Œæ‰§è¡Œ

2. **æµ‹è¯•éš”ç¦»**ï¼š
   - æ¯ä¸ªæµ‹è¯•ä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®åº“ï¼ˆin-memory SQLiteï¼‰
   - ç¡®ä¿æµ‹è¯•ä¹‹é—´ä¸ç›¸äº’å½±å“

3. **å¼‚æ­¥æµ‹è¯•**ï¼š
   - ç¡®ä¿æ‰€æœ‰ async æµ‹è¯•ä½¿ç”¨ `@pytest.mark.asyncio`
   - ä½¿ç”¨ `await` è°ƒç”¨ async æ–¹æ³•

---

## ğŸ¯ ä¸‹ä¸€æ­¥ä¼˜åŒ–

1. **æµ‹è¯•åˆ†ç»„**ï¼š
   - å•å…ƒæµ‹è¯•ï¼ˆå¿«é€Ÿï¼‰
   - é›†æˆæµ‹è¯•ï¼ˆä¸­ç­‰ï¼‰
   - E2E æµ‹è¯•ï¼ˆæ…¢é€Ÿï¼‰

2. **æµ‹è¯•ç¼“å­˜**ï¼š
   - ä½¿ç”¨ `pytest-cache` è·³è¿‡æœªæ›´æ”¹çš„æµ‹è¯•

3. **å¢é‡æµ‹è¯•**ï¼š
   - åªè¿è¡Œä¿®æ”¹æ–‡ä»¶ç›¸å…³çš„æµ‹è¯•

---

**ä¼˜åŒ–å®Œæˆæ—¶é—´**ï¼š2024-01-01  
**é¢„æœŸåŠ é€Ÿ**ï¼š3-4xï¼ˆä½¿ç”¨å¹¶è¡Œæ‰§è¡Œï¼‰

